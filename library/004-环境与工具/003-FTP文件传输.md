# FTP 文件传输

> - 系统：ubuntu 16.04 x64
> - 嵌入式：NUC980 linux-4.4内核



[TOC]

## 一、FTP服务器

### 下载并安装

```bash
sudo apt-get update
sudo apt install vsftpd -y
sudo service vsftpd restart
```

### 配置参数

```
/etc/vsftpd.conf

在这里为了省事直接允许匿名方式
1. 修改属性
anonymous_enable=NO -> anonymous_enable=YES
listen=NO -> listen=YES

2. 解除以下注释
anon_upload_enable=YES
anon_mkdir_write_enable=YES
anon_other_write_enable=YES		# ftp可以删除东西
write_enable=YES

3. 添加
anon_root=/home/name

4. 修改根目录权限
chmod a=rw /ftp		// 根目录不允许有写权限
mkdir /ftp/upload
chmod a=wrx	/ftp/upload	// 需要上传则新建文件夹
```

**配置完成后，重启vsftpd，再使用filezilla匿名连接即可**



## 二、公网ftp server的额外处理

> 由于公网的安全防护措施是在安全组中打开端口，通过上述的操作之后，发现
>
> - filezilla必须切换为主动模式
> - filezilla卡在读取目录列表
> - arm-linux通过ftpget/ftpput命令连接不上（timeout）

### 无法连接原因

FTP分为主动式（PORT）与被动式（PASV），并且FTP是分为命令链路（21）和数据链路

- PORT：服务器（21） --> 客户端，发起数据链路连接请求
- PASV：客户端 --> 服务器（端口需设置），发起数据链路连接请求

在FTP客户端中，默认都是使用PASV模式的，所以说，这个问题就在于也需要把FTP Server的数据链路端口也加入安全组

### 解决方法

1. 修改配置文件，添加pasv设置，将pasv服务器的端口固定	

   ```
   vim /etc/vsftpd.conf
   
   添加以下配置
   pasv_enable=YES  # 启用pasv模式
   pasv_min_port=30000 # 设置pasv模式中的可用端口范围（开始）
   pasv_max_port=30100 # 设置pasv模式中的可用端口范围（结束）
   pasv_address=39.108.4.89 # 设置pasv模式中的外网IP
   seccomp_sandbox=NO # 关闭 seccomp 功能
   ```

2. 在阿里云的安全组配置中，将30000-30100的端口添加到安全配置中

