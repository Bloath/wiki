# 拙诚无线系列产品通讯协议

> 本协议适用于拙诚带有NB通讯功能的系列产品
> - 2018-07-24 初始
> - 2018-08-21 
>   - 新增安检命令(E2H)，设备状态命令(86H)
>   - 将计量属性中结算日与阶梯计价合并，计量属性改为计量状态(85H)
>   - 错误标志位更新，将最低位禁用改为下发禁用，通过开关阀命令下发(E1H)
>   - 修改设备属性，去掉阀门禁用、安检状态，加入定期上传日期，与上传频率相悖
> - 2018-09-01 新增用气范围、时间段设置，恒流速判断设置
> - 2018-09-10 整合wifi协议
> - 2018-09-12 设备状态上传添加比例系数偏移量字段
> - 2018-09-15 设备注册新增类型字段，下发命令字改为17H
> - 2018-09-21 修改部分书写错误，用气时段字段含义修改
> - 2018-10-16 单位更新，充值中，气体充值最小单位从0.01m<sup>3</sup>修改为1m<sup>3</sup>
> - 2018-11-07 
>   - 充值部分加入时间戳作为验证ID，充值历史也加入相应字段
>   - 管道状态（83H）与设备状态（86H）合并为83H，为设备状态上传报文
>   - 增加设备中途断电报文（87H），在设备重新上电时立即发送
> - 2018-12-13 添加设备重置命令，为设置类命令，命令字为0x1F
> - 2019-01-16
>   - 修改阶梯计费协议
>   - 增加 温度压力采集时间 设置类报文，命令字为29H
>   - 增加 特征常数 设置/读取类报文，命令字为28H
>   - 增加 用户当天用气记录 上传类报文，命令字为86H
>   - 删除恒流设置，设备属性设置（11H）中增加恒流用量上限
>   - 将用气时段设置中的流量上限下限移动到设备属性设置中（11H）
>   - 删除重新上电上传，移动到错误上传中（81H）
>   - 报警上传框架调整，增加类型以及报警信息上传（81H）
>   - 历史类报文去掉个数，改为固定长度上传，无用的部分填0。
>   - 计量状态命令字改为85H
>   - 充值指令充值类型，0为读取，1-255为充值类型
> - 2019-03-04
>   - 统一表格格式，包含数据类型、名称、扩大倍数、长度等
>   - 数据类型包含 uint， int， timeStamp（uint32），bool，string等
>   - 扩大倍数是指对应单位时扩大N倍，例如流量，单位为m³，扩大倍数为3，上传数据为1000时，实际为 1m³，扩大10的3次方倍
> - 2019-03-28：修复设置设备属性相关膨胀系数
> - 2019-04-27：增加报警param字段解释




[TOC]




# 一、通讯框架

## 1.1 通讯机制

NB-Iot与wifi通讯虽然都是走运营商公网，但是基于不同的网络层以及传输层协议

|通讯方式|网络层|传输层|链接性质|优缺点|
|:---:|:---:|:---:|:---:|:---:|
|wifi|TCP|HTTP|短|需要主动链接服务器，获取命令|
|NB|UDP|CoAP|无|在核心网中即可主动接收下发指令，功耗低|

WIFI通讯采用了**短链接**的方式（主机从机、人为的半双工）

* 设备发起连接请求
* 服务器响应连接，建立连接
* 设备发送数据
* 服务器回复数据并主动关闭连接
* 设备关闭连接

NB 采用了**会话机制**（在会话保持期间，全双工）

* 设备上线，搜索核心网，PSM->idle
* 发送数据，建立会话（不需要握手）, idle->connect
* 运营商将设备加入网内，并保持会话（保持时间根据SIM类型主动配置），会话期间，设备可以收到下发指令
* 会话时间到，退出网内，设备从connect->idle模式，准备休眠



## 1.2 NB 通讯概述

### 1.2.1 Profile与插件

>使用NB模块很少有应用搭建自己的UDP通讯服务器，一般都是接入IoT平台，而接入平台就必须遵循IoT平台统一的协议格式，也就是统一的Profile与插件。

Profile与插件，其实就是设置通讯协议与具体字节对应关系

### 1.2.2 数据上传与命令下发

IoT平台将通讯分为两类

* **数据上传**：用于设备定期上传状态、数据、错误代码等
	* 强制添加：messageId，用于区分不同数据上传指令，一般用于填充**命令字节**
	* 自愿添加：应答，固定的几个字节
* **命令下发**：用于设备控制、属性设置等
	* 强制添加：messageId，一般用于填充**命令字节**，在响应报文中也要添加
	* 强制添加：mid，相当于id，用于区分不同的下发命令，在响应报文中也要添加
	* 强制添加：errorcode，只出现在响应报文中，表示下发命令的执行情况



### 1.3 WIFI 通讯概述

### 1.3.1 Http协议

* 通过DNS协议根据域名获取服务器IP地址
* 建立TCP连接服务器，端口为80
* 将协议报文转换为BCD码，以url参数的形式通过TCP向服务器发送get请求（支持子路由）

```http
GET /?message=68EE401357D8565A0000A1A2A3A4A500004816 HTTP/1.1
Host: wxio.cnzhuocheng.com


```

### 1.3.2 通讯机制

由于HTTP协议只支持设备请求，服务器应答的方式，无法实现“主机”实时对设备进行控制/设置，只能通过<font color="red">定时向服务器查询是否有暂存报文</font>来完成。设备按照一定频率向服务器查询是否有属于自身的操作，将操作处理完成后，将结果返回。

通讯分为以下三种类型

* **事件**：设备主动上传，用于上传错误以及报警信息，1次Http请求
	* 设备上传事件报文，服务器回复确认报文
* **设置**：设置设备参数等，2次Http请求
	* 设备向服务器发送 <font color="dark">查询暂存</font> 报文，服务器回复 <font color="dark">暂存设置报文</font>
	* 设置完成后，设备向服务器发送 <font color="dark">查询回复报文</font>，服务器回复 <font color="dark">接收成功</font> 报文
* **动作**：开关阀等设备动作，2次Http请求
	* 设备向服务器发送 <font color="dark">查询暂存</font> 报文，服务器回复 <font color="dark">暂存动作报文</font>
	* 动作完成后，设备向服务器发送 <font color="dark">查询回复报文</font>，服务器回复 <font color="dark">接收成功</font> 报文

>备注： 
* 设置与动作在通讯上区别不大，仅仅在于动作的两次Http请求之间有比较长的间隙，后续有超时判断的需求。
* 动作和设置的第二次Http请求中，设备完成操作后，要求**回复该指令所指属性的所有数据**，相当于回复属性查询指令。例如设置设备属性，在设置完成后，要回复所有的设备属性。
* 动作和设置的两次Http请求中，4条报文的ID是必须相同的，要求服务器在回复查询暂存时，将回复回复报文的ID与请求报文的ID进行同步，[报文ID详解](#2.4)



# 二、通讯协议

## 2.1 NB 通讯协议概述

>由于IoT平台自带通讯服务器功能与协议解析功能，传输给业务上层时，已经是解析好的JSON文件，所以下面的通讯协议，只需要嵌入式的相关开发人员查看即可。

### 2.1.1 传输规则


* 大端传输（高字节在前，低字节在后）
* 32位数据在NB-IoT只能解析为有符号数，即范围为-2147483648~2147483647
* 报文字符串为**大写**

### 2.1.2 报文帧格式

* 设备上发/平台回复

|名称|备注|占字节数||名称|备注|占字节数|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|messageId|命令字|1||固定字节|0xFF|1|
|data|数据|n||messageId|命令字|1|

```
上发：81 FF FF FF FF 00 00 00 01
回复：AA AA AA 00 00 00 (系统默认)
```

* 服务器下发/设备回复

|名称|备注|占字节数||名称|备注|占字节数|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|messageId|命令字|1||messageId|命令字|1|
|operation|读取为0x00<br>设置为0x01|1||errcode|执行状态|1|
|mid|报文ID|2||mid|报文ID|2|
|data|数据|n||data|数据|n|

```
下发：13 01 00 01 01 00 00 00 64
回复：13 00 00 01

```
>errcode：表示命令响应的命令执行状态，返回00表示命令执行成功，返回01表示命令执行失败

***
## 2.2 WIFI通讯协议概述

### 2.2.1 传输规则

* 小端传输（低字节在前，高字节在后）
* 报文字符串为**大写**

### 2.2.2 报文帧格式

|起始字-1|报文ID-1|控制域-1|长度-1|时间戳-4|地址域-7|命令字-1|数据-n|校验-1|结束字符-1|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|68H|||||||||16H|

* **报文ID**：1字节，报文的唯一ID，[报文ID详解](#2.4)
* **控制域**：1字节
	* D7：SDF，用于表示后续是否有暂存报文，0：没有暂存报文，1：有暂存报文，在服务器有多条暂存报文时，该位影响设备定时查询暂存的频率。**由服务器决定该位**。
	* D6-D0：设备类型，[设备类型列表](#2.3)，
* **时间戳**：4字节，设备重启后时间戳为0，
* **长 度** ：1字节，表示整个报文的长度，从起始字68H到结束字16H，最大不应超过200字节
* **地址域**：7字节，[地址域详解](#2.5)
* **命令字**：1字节，[命令字列表](#2.6)
* **校验字**：1字节，从68开始到校验之前的算术运算合并取反

>数据域之前的报文头，长度为16字节，数据域之后的报文尾，长度为2字节

### 2.2.3 设备列表

|代码|仪表说明|
|:---:|:---:|
||**燃气表**|
|30H|家用膜式燃气表|
|31H|商用膜式燃气表|
|32H|气体流量计|
||**其他**|
|40H|膜式燃气表计抄与安全管理器|
|42H|管道泄漏监测器|

## 2.2.4 报文ID详解

>报文ID是每次操作的标识，也是服务器与设备清除操作挂起的标识。以设备发起的Http请求中的报文ID为基准。以开阀（动作指令，2次Http请求）为例。报文ID是整个流程的标识，在处理其他流程时要进行自增。

1. 设备向服务器发起Http请求，内容为查询暂存。没有暂存报文时，报文ID不变
  * 命令/数据域：00H 00H，报文ID为99。
2. 服务器接收到请求，将暂存操作转换为动作报文，同步报文ID，回复Http请求
  * 命令/数据域/：E1H 02H，报文ID为99
  * 服务器状态切换为等待接收
3. 设备接收Http回复，设备状态切换为操作挂起，进行开关阀处理
4. 开阀完成，设备向服务器发起Http请求，内容为回复阀门状态，
  * 命令/数据域：E1H 02H， 报文ID为99
  * 设备状态切换为等待接收状态

5. 服务器接收到请求，回复接收成功报文
  * 命令/数据域：FFH 00H， 报文ID为99
  * 服务器状态切换为操作完成，清除挂起
6. 设备接收到回复，设备状态切换为操作完成，清除挂起和发送缓存



## 2.3 命令字列表
|下发/上传|命令|备注|
|:---:|:---:|:---:|
|00H / 00H|查询暂存|保留，用于设备加入核心网，下发数据|
||**读取/设置命令**||
|11H / 无|设备相关属性|不同报警的阈值，定时上传频率等|
|12H / 无|阶梯费用||
|13H / 23H|充值|将当次充值信息与设备进行同步|
|无 / 24H|用气历史数据|根据结算日，设备存储每月流量|
|15H / 无|用气范围、时段设置||
|17H / 无|用气设备注册||
|18H / 28H|特征常数|用户灶具右灶头特征常数|
|19H / 无|压力温度采集时间||
|1EH / 无|计费方式重置||
|1FH / 无|重置命令|将设备还原到出厂状态|
||**主动上传命令**||
|71H / 81H|报警事件|包含错误代码以及报警当时的所有状态|
|无 / 87H|管道参数上传|通过设置采集频率之后的温度压力数据上传|
|无 / 83H|设备状态|温度、压力、电量、偏差等状态|
|无 / 84H|阀门开关记录|包含开关阀的时间戳|
|无 / 85H|计量状态|绝对计量数据以及剩余计量数据|
|无 / 86H|用户当天用气记录|用户当天开气关气记录|
||**下发命令**||
|E1H / 无|开/关阀|1：关阀（并禁用)<br>2：开阀/解除禁用|
|E2H / 无|安检时间|下发安检时间|
|**其他**|||
|FEH|操作失败回复报文|数据域为00H，当服务器下发了设备不支持的命令或者设备出现某种问题无法正确执行操作时，回复该报文|
|FFH|服务器接收确认报文|数据域为00H，在动作和设置的第二次Http请求时<br>服务器回复该报文|



# 三、相关命令详解

>命令详解中，给出的demo都只为协议中的data部分。

## 3.1 通讯处理报文

### 3.1.1 查询暂存(WIFI)

```
// WIFI 完整报文，查询暂存 命令字=00 数据=00
68 02 40 13 4557255C 00107B497DC104 00 00 0F16
```




## 3.2 设置命令


### 设置设备属性 ( 0x11 ) 

|名称|类型|长度|扩大倍数(10的倍数)|单位|备注|
|:---:|:---:|:---:|:---:|:---:|:---:|
|超压报警阈值|uint|2|0|Pa||
|欠压报警阈值|uint|2|0|Pa||
|流速下限|uint|2|0|L/h||
|流速上限|uint|2|0|L/h||
|恒流超量阈值|uint|2|0|L||
|剩余流量报警阈值|uint|2|0|m³或元||
|安检周期|uint|1|0|月||
|温度报警阈值|uint|1|0|℃||
|未用气报警时长|uint|1|0|h||
|未开阀报警时长|uint|1|0|h||
|上传时段起始时间|uint|1|0|h||
|上传时段终止时间|uint|1|0|h||
|比例系数报警阈值|uint|1|0|%||
|比例系数报警是否禁用|bool|1|0|||
|免打扰起始小时|uint|1|0|h||
|免打扰结束小时|uint|1|0|h||
|定时泄漏日期|uint|1|0|||
|定时泄漏小时|uint|1|0|h||



### 设置阶梯计价 ( 0x12 ) 

|名称|类型|长度|扩大倍数(10的倍数)|单位|备注|
|:---:|:---:|:---:|:---:|:---:|:---:|
|主计划1起始时间|timeStamp|4|0|||
|主计划1结束时间|timeStamp|4|0|||
|主计划1结算类型|uint|1|0||0：未用<br>1：按月<br/>2：按季度<br/>3：按年<br/>4：按开始结束时间<br/>5：按天数|
|主计划1结算天数|uint|1|0|||
|主计划1阶梯1用量|uint|2|0|m³||
|主计划1阶梯1价格|uint|2|0|分||
|主计划1阶梯2用量|uint|2|0|m3||
|主计划1阶梯2价格|uint|2|0|分||
|主计划1阶梯3用量|uint|2|0|m³||
|主计划1阶梯3价格|uint|2|0|分||
|主计划1阶梯4用量|uint|2|0|m³||
|主计划1阶梯4价格|uint|2|0|分||
|主计划1阶梯5用量|uint|2|0|m³||
|主计划1阶梯5价格|uint|2|0|分||
|主计划1阶梯6用量|uint|2|0|m³||
|主计划1阶梯6价格|uint|2|0|分||
|备用计划1起始时间|timeStamp|4|0|||
|备用计划1结束时间|timeStamp|4|0|||
|备用计划1结算类型|uint|1|0||0：未用<br/>1：按月<br/>2：按季度<br/>3：按年<br/>4：按开始结束时间<br/>5：按天数|
|备用计划1结算天数|uint|1|0|||
|备用计划1阶梯1用量|uint|2|0|m³||
|备用计划1阶梯1价格|uint|2|0|分||
|备用计划1阶梯2用量|uint|2|0|m³||
|备用计划1阶梯2价格|uint|2|0|分||
|备用计划1阶梯3用量|uint|2|0|m³||
|备用计划1阶梯3价格|uint|2|0|分||
|备用计划1阶梯4用量|uint|2|0|m³||
|备用计划1阶梯4价格|uint|2|0|分||
|备用计划1阶梯5用量|uint|2|0|m³||
|备用计划1阶梯5价格|uint|2|0|分||
|备用计划1阶梯6用量|uint|2|0|m³||
|备用计划1阶梯6价格|uint|2|0|分||


* 6级阶梯，不需要可以填0

* 两个计费计划，默认计划1做为主要，计划2作为备用。根据不同的有效日期自动选择。需要强制替换，则写到计划1内


### 充值 ( 0x13 ) 

|名称|类型|长度|扩大倍数(10的倍数)|单位|备注|
|:---:|:---:|:---:|:---:|:---:|:---:|
|类型|uint|1|0||1：工况流量，2：标况流量，3：金额（工况），4：金额（标况）|
|充值量|uint|4|0|m³或元||
|充值时间|timeStamp|4|0|||


```
// 下发充值
{命令字：13H，数据区：{充值类型：1，充值量：5， 充值时间：1547607540}}
// 读取充值历史
{命令字：13H，数据区：{充值类型：0，充值量：0， 充值时间：0}}
```



### 充值历史 ( 0x23 ) 

|名称|类型|长度|扩大倍数(10的倍数)|单位|备注|
|:---:|:---:|:---:|:---:|:---:|:---:|
|记录1充值类型|uint|1|0|||
|记录1充值量|uint|4|0|||
|记录1充值时间|timeStamp|4|0|||
|记录2充值类型|uint|1|0|||
|记录2充值量|uint|4|0|||
|记录2充值时间|timeStamp|4|0|||
|记录3充值类型|uint|1|0|||
|记录3充值量|uint|4|0|||
|记录3充值时间|timeStamp|4|0|||
|记录4充值类型|uint|1|0|||
|记录4充值量|uint|4|0|||
|记录4充值时间|timeStamp|4|0|||
|记录5充值类型|uint|1|0|||
|记录5充值量|uint|4|0|||
|记录5充值时间|timeStamp|4|0|||
|记录6充值类型|uint|1|0|||
|记录6充值量|uint|4|0|||
|记录6充值时间|timeStamp|4|0|||
|记录7充值类型|uint|1|0|||
|记录7充值量|uint|4|0|||
|记录7充值时间|timeStamp|4|0|||
|记录8充值类型|uint|1|0|||
|记录8充值量|uint|4|0|||
|记录8充值时间|timeStamp|4|0|||
|记录9充值类型|uint|1|0|||
|记录9充值量|uint|4|0|||
|记录9充值时间|timeStamp|4|0|||
|记录10充值类型|uint|1|0|||
|记录10充值量|uint|4|0|||
|记录10充值时间|timeStamp|4|0|||

### 月用气历史 ( 0x24 ) 

|名称|类型|长度|扩大倍数(10的倍数)|单位|备注|
|:---:|:---:|:---:|:---:|:---:|:---:|
|记录1时间|timeStamp|4|0|||
|记录1花费|uint|4|2|元||
|记录1工况流量|uint|4|3|m³||
|记录1标况流量|uint|4|3|m³||
|记录2时间|timeStamp|4|0|||
|记录2花费|uint|4|2|元||
|记录2工况流量|uint|4|3|m³||
|记录2标况流量|uint|4|3|m³||
|记录3时间|timeStamp|4|0|||
|记录3花费|uint|4|2|元||
|记录3工况流量|uint|4|3|m³||
|记录3标况流量|uint|4|3|m³||
|记录4时间|timeStamp|4|0|||
|记录4花费|uint|4|2|元||
|记录4工况流量|uint|4|3|m³||
|记录4标况流量|uint|4|3|m³||
|记录5时间|timeStamp|4|0|||
|记录5花费|uint|4|2|元||
|记录5工况流量|uint|4|3|m³||
|记录5标况流量|uint|4|3|m³||
|记录6时间|timeStamp|4|0|||
|记录6花费|uint|4|2|元||
|记录6工况流量|uint|4|3|m³||
|记录6标况流量|uint|4|3|m³||
|记录7时间|timeStamp|4|0|||
|记录7花费|uint|4|2|元||
|记录7工况流量|uint|4|3|m³||
|记录7标况流量|uint|4|3|m³||
|记录8时间|timeStamp|4|0|||
|记录8花费|uint|4|2|元||
|记录8工况流量|uint|4|3|m³||
|记录8标况流量|uint|4|3|m³||
|记录9时间|timeStamp|4|0|||
|记录9花费|uint|4|2|元||
|记录9工况流量|uint|4|3|m³||
|记录19标况流量|uint|4|3|m³||
|记录10时间|timeStamp|4|0|||
|记录10花费|uint|4|2|元||
|记录10工况流量|uint|4|3|m³||
|记录10标况流量|uint|4|3|m³||
|记录1时间|timeStamp|4|0|||
|记录11花费|uint|4|2|元||
|记录11工况流量|uint|4|3|m³||
|记录11标况流量|uint|4|3|m³||
|记录12时间|timeStamp|4|0|||
|记录12花费|uint|4|2|元||
|记录12工况流量|uint|4|3|m³||
|记录12标况流量|uint|4|3|m³||

### 设置用气时段 ( 0x15 ) 

|名称|类型|长度|扩大倍数(10的倍数)|单位|备注|
|:---:|:---:|:---:|:---:|:---:|:---:|
|用气时段1起始|uint|1|0|||
|用气时段1终止|uint|1|0|||
|用气时段2起始|uint|1|0|||
|用气时段2终止|uint|1|0|||
|用气时段3起始|uint|1|0|||
|用气时段3终止|uint|1|0|||

### 设备注册 ( 0x17 ) 

|名称|类型|长度|扩大倍数(10的倍数)|单位|备注|
|:---:|:---:|:---:|:---:|:---:|:---:|
|注册设备1类型|uint|1|0|||
|注册设备1流速|uint|2|0|L/h||
|注册设备2类型|uint|1|0|||
|注册设备2流速|uint|2|0|L/h||
|注册设备3类型|uint|1|0|||
|注册设备3流速|uint|2|0|L/h||



### 特征常数操作 ( 0x18 ) 

|名称|类型|长度|扩大倍数(10的倍数)|单位|备注|
|:---:|:---:|:---:|:---:|:---:|:---:|
|是否为标定|bool|1|0|||

### 设备特征常数 ( 0x28 ) 

|名称|类型|长度|扩大倍数(10的倍数)|单位|备注|
|:---:|:---:|:---:|:---:|:---:|:---:|
|标定特征常数|uint|4|0|||
|管道压力|int|4|1|Pa||
|流速|uint|2|0|L/h||
|温度|int|2|1|℃||
|采集时间|timeStamp|4|0|||
|当前特征常数|uint|4|0|||
|管道压力|int|4|1|Pa||
|流速|uint|2|0|L/h||
|温度|int|2|1|℃||
|采集时间|timeStamp|4|0|||

> 使用用例

```
// 下发，启动采集
命令字: 0x18, 数据区: {是否为设置: 1}
// 下发，读取常数
命令字: 0x18, 数据区: {是否为设置: 0}

// 上发
命令字: 0x28, 数据区: {特征常数: 7946832, 管道绝对压力：101000，流速：300，温度：273，时间戳: 1547607540}
```

### 设置采集时间 ( 0x19 ) 

|名称|类型|长度|扩大倍数(10的倍数)|单位|备注|
|:---:|:---:|:---:|:---:|:---:|:---:|
|时间1|uint|1|0|h||
|时间2|uint|1|0|h||
|时间3|uint|1|0|h||
|时间4|uint|1|0|h||
|时间5|uint|1|0|h||



### 计费方式重置 ( 0x1E ) 

|名称|类型|长度|扩大倍数(10的倍数)|单位|备注|
|:---:|:---:|:---:|:---:|:---:|:---:|
|无||||||



### 重置 ( 0x1F ) 

|名称|类型|长度|扩大倍数(10的倍数)|单位|备注|
|:---:|:---:|:---:|:---:|:---:|:---:|
|地址|string|30|0|||
|端口|string|10|0|||


## 3.3 事件命令

### 故障报警 ( 0x81 ) 

#### 数据区组成


|名称|类型|长度|扩大倍数(10的倍数)|单位|备注|
|:---:|:---:|:---:|:---:|:---:|:---:|
|上传类型|uint|1|0||0：触发错误，1：清除错误|
|故障序号|uint|1|0|||
|当前故障标志位|uint|4|0|||
|末次时间|timeStamp|4|0|||
|发生时间|timeStamp|4|0|||
|时长|uint|4|0|s||
|是否用气|bool|1|0|||
|是否关阀|bool|1|0|||
|流速|uint|2|0|L/h||
|管道压力|uint|4|1|Pa||
|大气压力|uint|4|1|Pa||
|压力温度|int|2|1|℃||
|室内温度|int|2|1|℃||
|比例系数初始值-1|uint|2|2|%||
|比例系数初始值-2|uint|2|2|%||
|比例系数初始值-3|uint|2|2|%||
|比例系数初始值-4|uint|2|2|%||
|比例系数当前值-1|uint|2|2|%||
|比例系数当前值-2|uint|2|2|%||
|比例系数当前值-3|uint|2|2|%||
|比例系数当前值-4|uint|2|2|%||
|参数|uint|1|0|||



#### PS：参数一般为空，对于个别报警，参数代表不同意义

* 拆表，1：掉电时间过长，2：开阀拆表(压力过低超时)，3：关阀拆表(压力过低并重检后仍然低)
* 计量精度下降：偏差值



#### 错误标志位列表以及报警号码

>下表为32位错误标志位bitmap，以及标志位对应的错误代码

|位索引|故障名称|故障代码|备注|
|:---:|:---:|:---:|:---:|
|0|平台下发禁用|E00|后台下发禁用|
|1|阶梯计费超出有效期|E04||
|2|余量不足|E30||
|3|欠费|E30||
|4|计量装置故障|E24|磁开关损坏|
|5|阀门故障|E25|电流不足，关闭后依然用气|
|6|气表损坏|E22||
|7|流量过载|E35||
|8|电池欠压|E32||
|9|长时间未用气|E39||
|10|恒流超量|E36||
|11|恒流超时|E37||
|12|报警器报警|E11||
|13|安检到期|E31||
|14|软管破损|E10||
|15|强磁干扰|E23||
|16|管道超压|E33||
|17|管道欠压|E34||
|18|环境温度过高|E38||
|19|地震|||
|20|计量精度下降|E21||
|21|压力传感器故障|E27||
|22|存储故障|E29||
|23|异常小流量|E20||
|24|板载传感器故障|E28||
|25|在非用气时段使用|E01||
|26|非注册设备|E02||
|27|拆表|E03||
||NB通讯故障|E05||



### 管道环境参数 ( 0x87 ) 

|名称|类型|长度|扩大倍数(10的倍数)|单位|备注|
|:---:|:---:|:---:|:---:|:---:|:---:|
|记录1压力|int|2|0|Pa||
|记录1温度|int|2|1|℃||
|记录1时间|uint|1|0|||
|记录2压力|int|2|0|Pa||
|记录2温度|int|2|1|℃||
|记录2时间|uint|1|0|||
|记录3压力|int|2|0|Pa||
|记录3温度|int|2|1|℃||
|记录3时间|uint|1|0|||
|记录4压力|int|2|0|Pa||
|记录4温度|int|2|1|℃||
|记录4时间|uint|1|0|||
|记录5压力|int|2|0|Pa||
|记录5温度|int|2|1|℃||
|记录5时间|uint|1|0|||

### 设备状态 ( 0x83 ) 

|名称|类型|长度|扩大倍数(10的倍数)|单位|备注|
|:---:|:---:|:---:|:---:|:---:|:---:|
|压力|int|2|0|Pa||
|温度|int|2|1|℃||
|是否用气|bool|1|0|||
|信号强度|uint|1|0|||
|是否禁用|bool|1|0|||
|是否关阀|bool|1|0|||
|电池电压|uint|1|1|V||
|偏转比例|uint|1|0|%||



### 阀门开关记录 ( 0x84 ) 

|名称|类型|长度|扩大倍数(10的倍数)|单位|备注|
|:---:|:---:|:---:|:---:|:---:|:---:|
|开阀时间|timeStamp|4|0|||
|关阀时间|timeStamp|4|0|||


### 计量状态 ( 0x85 ) 

|名称|类型|长度|扩大倍数(10的倍数)|单位|备注|
|:---:|:---:|:---:|:---:|:---:|:---:|
|工况流量|uint|4|3|m³||
|剩余工况流量|uint|4|3|m³||
|标况流量|uint|4|3|m³||
|剩余标况流量|uint|4|3|m³||
|剩余金额|uint|4|2|元||
|当前气价|uint|2|2|元||



### 日用气历史 ( 0x86 ) 

|名称|类型|长度|扩大倍数(10的倍数)|单位|备注|
|:---:|:---:|:---:|:---:|:---:|:---:|
|记录1起始时间|timeStamp|4|0|||
|记录1结束时间|timeStamp|4|0|||
|记录1用量|uint|4|3|m³||
|记录2起始时间|timeStamp|4|0|||
|记录2结束时间|timeStamp|4|0|||
|记录2用量|uint|4|3|m³||
|记录3起始时间|timeStamp|4|0|||
|记录3结束时间|timeStamp|4|0|||
|记录3用量|uint|4|3|m³||
|记录4起始时间|timeStamp|4|0|||
|记录4结束时间|timeStamp|4|0|||
|记录4用量|uint|4|3|m³||
|记录5起始时间|timeStamp|4|0|||
|记录5结束时间|timeStamp|4|0|||
|记录5用量|uint|4|3|m³||



## 3.4 非设置下发命令

### 开关阀操作 ( 0xE1 ) 

|名称|类型|长度|扩大倍数(10的倍数)|单位|备注|
|:---:|:---:|:---:|:---:|:---:|:---:|
|关阀（禁用）|bool|1|0|||

### 安检 ( 0xE2 ) 

|名称|类型|长度|扩大倍数(10的倍数)|单位|备注|
|:---:|:---:|:---:|:---:|:---:|:---:|
|安检时间|timeStamp|4|0|||

### 清除故障 ( 0x71 ) 

|名称|类型|长度|扩大倍数(10的倍数)|单位|备注|
|:---:|:---:|:---:|:---:|:---:|:---:|
|故障序号|uint|1|0|||

