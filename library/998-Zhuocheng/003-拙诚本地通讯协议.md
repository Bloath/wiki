# 拙诚系列产品本地通讯协议

>本协议适用于拙诚表具产品本地读取与设置
>

[TOC]


## 一、通讯框架

* 通讯方式：串口
* 通讯介质：TTL
* 主从机：电脑为主机，设备为从机


## 二、通讯协议

#### 2.1 传输规则

* 大端传输（高字节在前，低字节在后）
* 报文字符串为**大写**

#### 2.2 报文帧格式

|起始字-1|报文ID-1|控制域-1|长度-1|时间戳-4|地址域-7|命令字-1|数据-n|校验-1|结束字符-1|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|68H|||||||||16H|

* **报文ID**：任意
* **控制域**：任意
* **时间戳**：任意
* **长 度** ：1字节，表示整个报文的长度，从起始字68H到结束字16H，最大不应超过200字节
* **地址域**：本地通讯，全为0
* **命令字**：1字节，[命令字列表](#2.6)
* **校验字**：1字节，从68开始到校验之前的算术运算合并取反

>数据域之前的报文头，长度为16字节，数据域之后的报文尾，长度为2字节



#### 2.5 命令字列表
|下发/上传|命令|备注|
|:---:|:---:|:---:|
|A1H / B2H|设置本地参数||
|A2H / B2H|读取本地参数|数据域为空，填00即可|
|A3H / 81H|本地读取报警信息|下发命令后，会分多条上传全部报警信息|
|A4H / B4H|  读取日用气历史  ||
|A5H / 24H|  读取月用气历史  ||


## 三、相关命令详解

### 3.1 设置本地参数（0xA1 / 0xB2）

**下发报文内容**

|内容|格式|字节数|备注|
|:---:|:---:|:---:|:---:|
|表底数（L）|uint32|4||
|回转系数|uint16|2|回转体积除以0.8|
|齿轮1齿数|uint8|1||
|齿轮2齿数|uint8|1||
|地址|bytes|7||
|公称流量(0.1L)|uint8|1|`2.5L`=>`25`|
|主机地址|char|30||
|主机端口|char|10||

**上传报文内容**

见3.2 读取本地参数

### 3.2 读取本地参数（0xA2 / 0xB2）

**下发报文内容**

数据域为空

**上传报文内容**

|      内容      |  格式  | 字节数 |      备注       |
| :------------: | :----: | :----: | :-------------: |
|  表底数（L）   | uint32 |   4    |                 |
|    回转系数    | uint16 |   2    | 回转体积除以0.8 |
|   齿轮1齿数    | uint16 |   1    |                 |
|   齿轮2齿数    | uint16 |   1    |                 |
|      地址      | bytes  |   7    |                 |
| 公称流量(0.1L) | uint8  |   1    |  `2.5L`=>`25`   |
|    主机地址    |  char  |   30   |                 |
|    主机端口    |  char  |   10   |                 |



### 3.2 读取本地报警信息（0xA3 / 0x81）

**下发报文内容**

数据域为空

**上传报文内容**

见nb&wifi模块报警上传（0x81）

### 3.3 读取日用气历史（0xA4 / 0xB4）

**下发报文内容**

数据域为空

**上传报文内容**

一共30条

|   内容   |  格式  | 字节数 |   备注   |
| :------: | :----: | :----: | :------: |
| 用气量1  | uint32 |   4    | 单位为L  |
| 用气量2  | uint32 |   4    | 单位为L  |
| ·······  |        |        |          |
| 用气量30 | uint32 |   4    | `单位为L |

### 3.2 读取月用气历史（0xA5 / 0x24）

**下发报文内容**

数据域为空

**上传报文内容**

见nb&wifi通讯协议--月用气历史（0x24）