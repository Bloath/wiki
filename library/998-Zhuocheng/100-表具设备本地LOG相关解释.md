# 表具设备本地LOG相关解释



## 一、WIFI通讯

> wifi通讯分以下几个部分

|         阶段         |                            详细                             |               启动LOG               |                  反馈LOG                   |
| :------------------: | :---------------------------------------------------------: | :---------------------------------: | :----------------------------------------: |
|       本地阶段       |                      WIFI模块连接WIFI                       |      无，在打开电源后自动连接       |            成功：`WIFI GOT IP`             |
| 通讯阶段=>连接服务器 | 发送TCP CONNECT握手请求<br>类似打电话拨号阶段，成功则为接通 | `AT+CIPSTART=111.222.333.444, 8080` | 成功：`CONNECT OK`<br>失败：`ERROR_CLOSED` |
|  通讯阶段=>发送数据  |        发送TCP数据包，成功则表明业务服务器接收到数据        | `AT+CIPSEND=n`<br>`receive n bytes` |    成功：`SEND OK`<br>失败：`SEND FAIL`    |
| 业务服务器=>回复阶段 |                                                             |               看下图                |                                            |





```
一次完整的通讯流程

1. 启动WIFI模块并自动连接WIFI
[13:08:29]LOG: Enable Wifi Power
[13:08:35]AT+CWMODE_DEF=1
[13:08:35]AT+CWAUTOCONN=1
[13:08:35]AT+CWMODE_DEF=1
[13:08:35]OK
[13:08:35]AT+CWAUTOCONN=1
[13:08:35]OK
[13:08:35]WIFI GOT IP	<<<<<<< WIFI连接成功并获取到IP地址
[13:08:41]AT+CWJAP?
[13:08:41]AT+CIPSTART="TCP","58.59.64.11",8078
[13:08:41]AT+CWJAP?
[13:08:41]+CWJAP:"526","b0:95:8e:ca:8b:33",2,-46     <<<<<<<<<<<<< 设备主动查询WIFI连接情况，如果未连接
[13:08:41]OK

2. 通讯阶段=>连接服务器
[13:08:41]AT+CIPSTART="TCP","58.59.64.11",8078
[13:08:41]CONNECT
[13:08:41]OK		<<<<<<<<< 通讯服务器连接成功，失败则回复ERROR CLOSED

3. 通讯阶段=>发送数据
[13:08:41]AT+CIPSEND=134
[13:08:41]AT+CIPSEND=134
[13:08:41]OK
[13:08:41]> GET /communication?message=6883401C5C8C84CD00000000000001830A4E00BA000000003304B216 HTTP/1.1
[13:08:41]Host:58.59.64.11:8078
[13:08:41]Connection: close
[13:08:41]Recv 134 bytes
[13:08:41]SEND OK	<<<<<<<<<<<<<<< 说明通讯链路没问题，通讯将数据转交给业务服务器，失败则为SEND FAIL


4. 业务服务器=>回复阶段，该阶段主要标志位+IPD，说明收到数据
[13:08:42]+IPD,145:HTTP/1.1 200
[13:08:42]Transfer-Encoding: chunked
[13:08:42]Date: Sat, 16 Mar 2019 05:08:41 GMT
[13:08:42]Connection: close
[13:08:42]26
[13:08:42]688340135C8C84D900000000000001FF00F916        <<<<<<<<< 有的时候只有前面的信息，没有该信息，则说明设备未在业务服务器注册
[13:08:42]+IPD,5:0
[13:08:42]CLOSED
```

